---
layout: "post"
title: "Сервисная архитектура ISP и универсальная транспортная сеть"
tags: architecture isp vxlan mpls arista clos
author: "ipotech"
---

Сервисная архитектура ISP и универсальная транспортная сеть

## Disclaimer
Многое описанное тут мое мнение, сформированное под действием фантазии и фантазии крутых чуваков, это не серебряная пуля, а так же имеет особенности конкретной реализации isp в котором я работаю. Если не пугает, то читайте.

## Описание
![architecture-isp](/images/architecture-isp.png)

Сервисная архитектура из названия диктует, что каждая сущность системы должна быть обособлена и предоставлять сервис другой сущности через понятное API
### Подробнее о слоях
* **Поставщики** - любые источники контента будь то, сам интернет или OTT и VOIP, или КТВ и POTS
* **Бренд** - комплекс оборудования для билингации трафика, например BNG или SBC
* **Универсальная транспортная сеть** - состоит из магистральной транспортной сети и распределительной транспортной сети. В частном можно представить это и одной сущностью. Транспортная сеть может иметь арендованные ресурсы, например, ПМ через других isp.
* **Физическая сеть** - слой пассивной оптический и не только коммутации. Так же может иметь арендованные ресурсы у других провайдеров(темные волокна)
* **Платформа** - система computenode вычислительный кластер, например, openstack, vmware, и тд. Платформа может иметь свою сеть, но так же может арендовать сеть у транспортной сети.
* **Инфраструктура** - автозалы, энергетика, климат.
* **Клиенты** - конечные пользователи услуг бренда.
Такое разделение позволяет четко определить зоны ответственности, что повышает качество. Так как появляется конкуренция, никто больше не обязывает брать услугу только у одного поставщика.

## Универсальная транспортная сеть
Сфокусируемся на варианте реализации транспортной сети, а точнее на ее магистральной части.
Допустим в вашей сети есть равноудаленные площадки, на которых сосредоточено ваше "ядро" - BNG, computenode, коммутаторы агрегации, маршрутизаторы и тд.

Главная бизнес цель: транспортное оборудование должно обеспечить связность между клиентами и ядром. По факту дать L2VPN и L3VPN.<br>
Классические варианты предполагают строить север-юг сети или на STP, или на MPLS. Оба решения имеют минусы, а главное не дают ответ как жить в эпоху VNF и SDN эры.
Я же предлагаю посмотреть на сеть как на один большой "датацентр", где площадки соединены в топологию CLOS. К похожему выводу приходит в своей [статье](http://karneliuk.com/2019/01/sp-part-3-automated-service-provider-fabric-with-arista-cisco-nokia-and-ansible/) Антон Карнелюк. А так же ONF советует строить современные сети по принципу _The CORD (Central Office Re-architected as a Datacenter)_ [opencord](https://www.opennetworking.org/cord/)

Итак, в современном мире датацентры строят с использованием EVPN/VXLAN. Это позволяет распределять оборудование бренда и computenode на любых площадках, а задача транспортной сети дать им связь или L2, или L3.

![arch-pop](/images/arch-pop.png)
При этом можно выделить такие роли:
- Виртуальный распределенный коммутатор - l2 транспорт между устройствами бренда и терминацией на площадках(локальные особенности), то есть всем PE устройствами.
- Виртуальный распределенный маршрутизатор - L3VPN для Платформы
- Транспорт для IPTV multicast

**Далее пока теория построения на оборудование Arista 7280SR.**<br>
**Реальные конфигурации и опыт в следующих статьях**
### Виртуальный распределенный коммутатор
В этом кейсе ТСПД дает L2 связность между маршрутизаторами.

Маршрутизаторы AX поверх ТСПД строят MPLS сеть, чтобы давать услуги p2p \(pw kompella\) и p2mp l2vpn \(EVPN\), l3vpn \(включая интернет и EVPN\):
![протоколы](/images/ipotech-a2-protocols.png)

![метки](/images/ipotech-protocol-labels.png)

Фабрика построена с EBGP underlay и iBGP overlay. В качестве  транспорта используется VXLAN. Такая связка позволит сделать EVPN/VXLAN фабрику с L2 и L3 vpn как сервисы.
VTEP распределен по двум leaf свичам площадки. Для обеспечения резервирования используется MLAG в сторону CE. Для обеспечения работы MLAG между leaf организован служебный линк. В норме по этому линку ходят только служебные сообщения, трафик туда попадает только для single home CE подключений, например при аварии CE-LEAF линка.

Балансировка на линках LEAF-SPINE происходит по хэшу -3 заголовка от VTEP с ECMP.
И вот тут есть особенности и вероятно ограничения. Смотри [тут](/_posts/2019-06-24-juniper-mx-mpls-examples.md).

### Виртуальный распределенный маршрутизатор
LEAF оборудование транспортной сети выступает в роли PE маршрутизатора для терминирования IPv4 и IPv6 подсетей ВМ и контейнеров.

Терминирование происходит в L3 EVPN инстанс с Symmetric IRB.
Для обеспечения связности между сервисными маршрутизаторами бренда, маршрутизаторами терминации и LEAF можно, например, поднять BGP option A стык, для каждого vrf.
Для обеспечения безопасности на интерфейсах LEAF оборудования конфигурируются ACL по L2-L4 заголовкам.
![vrouter](/images/ipotech-vrouter.png)

### Транспорт IPTV multicast
IP фабрика маршрутизирует PIM в underlay.

## Ссылки
- https://www.opennetworking.org/cord/
- http://karneliuk.com/2019/01/sp-part-3-automated-service-provider-fabric-with-arista-cisco-nokia-and-ansible/
